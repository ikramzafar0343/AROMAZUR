{%- assign product_form_id = 'product-form-' | append: section.id -%}
{%- liquid
  assign selected_variant = product.selected_or_first_available_variant
  assign has_discount = false
  if product.compare_at_price > product.price
    assign has_discount = true
  endif
  
  assign save_amount = product.compare_at_price | minus: product.price
  assign coverage_text = ''
  if product.description contains 'sq ft' or product.description contains 'sqft' or product.description contains 'coverage'
    assign coverage_text = product.description | split: 'sq' | first | split: 'coverage' | last | strip
  endif
-%}

<section class="az-product az-page-transition" data-product-page>
  <!-- Breadcrumbs -->
  <div class="page-width">
    <nav class="az-product__breadcrumbs" aria-label="Breadcrumb">
      <ol class="az-product__breadcrumbs-list">
        <li><a href="{{ routes.root_url }}">Home</a></li>
        {% if collection %}
          <li><a href="{{ collection.url }}">{{ collection.title }}</a></li>
        {% endif %}
        <li aria-current="page">{{ product.title }}</li>
      </ol>
    </nav>
  </div>

  <div class="page-width az-product__container">
    <div class="az-product__grid">
      <!-- Product Gallery -->
      <div class="az-product__gallery">
        {% if product.images.size > 0 %}
          <div class="az-product__gallery-main" data-product-gallery-main>
            {% for image in product.images %}
              <div class="az-product__gallery-item {% if forloop.first %}is-active{% endif %}" data-gallery-index="{{ forloop.index0 }}">
                {{ image | image_url: width: 1200 | image_tag: loading: 'lazy', decoding: 'async', alt: product.title }}
                {% if forloop.first and product.tags contains 'new' %}
                  <span class="az-product__badge">NEW</span>
                {% elsif forloop.first and has_discount %}
                  <span class="az-product__badge">SALE</span>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          
          {% if product.images.size > 1 %}
            <div class="az-product__gallery-thumbs" data-product-gallery-thumbs>
              {% for image in product.images %}
                <button class="az-product__gallery-thumb {% if forloop.first %}is-active{% endif %}" 
                        type="button" 
                        data-gallery-thumb="{{ forloop.index0 }}"
                        aria-label="View image {{ forloop.index }}">
                  {{ image | image_url: width: 200 | image_tag: loading: 'lazy', decoding: 'async', alt: product.title }}
                </button>
              {% endfor %}
            </div>
          {% endif %}
        {% else %}
          <div class="az-product__gallery-placeholder">
            <svg width="120" height="120" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4 16L10.5 9.5L14.5 13.5L20 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M20 12V20H4V4H12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        {% endif %}
      </div>

      <!-- Product Info -->
      <div class="az-product__info">
        <!-- Header Info -->
        <div class="az-product__header">
          {% if product.type != blank %}
            <div class="az-product__category">{{ product.type }}</div>
          {% endif %}
          
          <h1 class="az-product__title">{{ product.title }}</h1>
          
          {% if product.metafields.reviews.rating or product.metafields.reviews.count %}
            <div class="az-product__rating">
              {% assign rating = product.metafields.reviews.rating.value | default: 4.5 %}
              {% assign reviews_count = product.metafields.reviews.count.value | default: 0 %}
              <div class="az-product__stars">
                {% for i in (1..5) %}
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" 
                          fill="{% if i <= rating %}currentColor{% else %}none{% endif %}" 
                          stroke="currentColor" 
                          stroke-width="2"/>
                  </svg>
                {% endfor %}
              </div>
              <span class="az-product__reviews">({{ reviews_count }} reviews)</span>
            </div>
          {% endif %}
          
          {% if coverage_text != blank %}
            <div class="az-product__coverage">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2Z" stroke="currentColor" stroke-width="2"/>
                <path d="M12 11C13.1046 11 14 10.1046 14 9C14 7.89543 13.1046 7 12 7C10.8954 7 10 7.89543 10 9C10 10.1046 10.8954 11 12 11Z" stroke="currentColor" stroke-width="2"/>
              </svg>
              Covers {{ coverage_text }}
            </div>
          {% endif %}
        </div>

        <!-- Purchase Card -->
        <div class="az-product__purchase">
          <div class="az-product__pricing">
            <div class="az-product__price">
              <span class="az-product__price-current">{{ product.price | money }}</span>
              {% if has_discount %}
                <span class="az-product__price-compare">{{ product.compare_at_price | money }}</span>
                <span class="az-product__save">Save {{ save_amount | money }}</span>
              {% endif %}
            </div>
          </div>

          {% form 'product', product, id: product_form_id, class: 'az-product__form' %}
            {% if product.has_only_default_variant == false %}
              <div class="az-product__variants">
                {% for option in product.options_with_values %}
                  <div class="az-product__variant-group">
                    <label class="az-product__variant-label" for="Option-{{ section.id }}-{{ forloop.index0 }}">
                      {{ option.name }}
                    </label>
                    <div class="az-product__variant-options">
                      {% for value in option.values %}
                        <button type="button" 
                                class="az-product__variant-option {% if option.selected_value == value %}is-selected{% endif %}"
                                data-option="{{ option.name | escape }}"
                                data-value="{{ value | escape }}"
                                data-option-index="{{ forloop.parentloop.index0 }}"
                                data-value-index="{{ forloop.index0 }}">
                          {{ value }}
                        </button>
                      {% endfor %}
                    </div>
                    <select id="Option-{{ section.id }}-{{ forloop.index0 }}"
                            name="options[{{ option.name | escape }}]"
                            class="az-product__variant-select"
                            data-variant-select>
                      {% for value in option.values %}
                        <option value="{{ value | escape }}" {% if option.selected_value == value %}selected{% endif %}>
                          {{ value }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            <div class="az-product__quantity">
              <label class="az-product__quantity-label" for="Quantity-{{ section.id }}">Quantity</label>
              <div class="az-product__quantity-controls">
                <button type="button" class="az-product__qty-btn" data-qty-decrease aria-label="Decrease quantity">−</button>
                <input type="number" 
                       id="Quantity-{{ section.id }}"
                       class="az-product__qty-input" 
                       name="quantity" 
                       value="1" 
                       min="1" 
                       max="99"
                       data-qty-input>
                <button type="button" class="az-product__qty-btn" data-qty-increase aria-label="Increase quantity">+</button>
              </div>
            </div>

            <input type="hidden" name="id" value="{{ selected_variant.id }}" data-variant-id>
            
            <button type="submit" 
                    class="az-product__add-btn {% if is_added %}is-added{% endif %}" 
                    {% unless selected_variant.available %}disabled{% endunless %}
                    data-add-to-cart>
              {% if selected_variant.available %}
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                  <path d="M6 2L3 6V20C3 21.1046 3.89543 22 5 22H19C20.1046 22 21 21.1046 21 20V6L18 2H6Z" stroke="currentColor" stroke-width="2"/>
                  <path d="M3 6H21" stroke="currentColor" stroke-width="2"/>
                  <path d="M16 10C16 12.2091 14.2091 14 12 14C9.79086 14 8 12.2091 8 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span data-add-text>Add to cart</span>
                <span data-added-text hidden>Added!</span>
              {% else %}
                Sold out
              {% endif %}
            </button>
          {% endform %}
        </div>

        <!-- Accordions -->
        <div class="az-product__accordions" data-product-accordions>
          {% if product.description != blank %}
            <div class="az-product__accordion">
              <button class="az-product__accordion-header" type="button" data-accordion-toggle>
                <span>Description</span>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <div class="az-product__accordion-content">
                <div class="rte">{{ product.description }}</div>
              </div>
            </div>
          {% endif %}

          <div class="az-product__accordion">
            <button class="az-product__accordion-header" type="button" data-accordion-toggle>
              <span>Shipping & Returns</span>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="az-product__accordion-content">
              <p>Free shipping on orders over €100. Returns accepted within 30 days of purchase.</p>
            </div>
          </div>

          {% if coverage_text != blank %}
            <div class="az-product__accordion">
              <button class="az-product__accordion-header" type="button" data-accordion-toggle>
                <span>Coverage</span>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <div class="az-product__accordion-content">
                <p>This product covers {{ coverage_text }}.</p>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Bar -->
  <div class="az-product__mobile-bar" data-product-mobile-bar>
    <div class="page-width az-product__mobile-bar-inner">
      <div class="az-product__mobile-price">
        <span class="az-product__mobile-price-current">{{ product.price | money }}</span>
        {% if has_discount %}
          <span class="az-product__mobile-price-compare">{{ product.compare_at_price | money }}</span>
        {% endif %}
      </div>
      <button type="button" class="az-product__mobile-add-btn" data-mobile-add-to-cart {% unless selected_variant.available %}disabled{% endunless %}>
        {% if selected_variant.available %}
          Add to cart
        {% else %}
          Sold out
        {% endif %}
      </button>
    </div>
  </div>

  <!-- Related Products -->
  {% if collection and collection.products_count > 1 %}
    <div class="az-product__related">
      <div class="page-width">
        <h2 class="az-product__related-title">You may also like</h2>
        <div class="az-product__related-grid">
          {% for related_product in collection.products limit: 4 %}
            {% if related_product.id != product.id %}
              <div class="az-product__related-item">
                <a href="{{ related_product.url }}">
                  {% if related_product.featured_image %}
                    {{ related_product.featured_image | image_url: width: 400 | image_tag: loading: 'lazy', alt: related_product.title }}
                  {% endif %}
                  <h3 class="az-product__related-item-title">{{ related_product.title }}</h3>
                  <div class="az-product__related-item-price">{{ related_product.price | money }}</div>
                </a>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}
</section>

{% schema %}
{
  "name": "Product",
  "tag": "section",
  "class": "section-main-product",
  "settings": []
}
{% endschema %}
